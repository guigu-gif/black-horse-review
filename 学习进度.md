# Redis 实战篇学习进度

## 📅 2025年2月13日 星期四

### ✅ 今天完成的内容

#### 1. 秒杀模块 - 基础实现
- **超卖问题**
  - 理解了并发导致超卖的原因（查询和扣减不是原子操作）
  - 使用乐观锁解决：`WHERE stock > 0`
  - 修改代码：`VoucherOrderServiceImpl.java` 第 58-62 行

- **一人多单问题**
  - 理解了为什么需要防止一人多单
  - 使用 `synchronized` 锁用户 ID
  - 理解了锁的粒度：按用户 ID 加锁，而不是锁整个方法

- **集群问题**
  - 理解了 `synchronized` 在集群环境下失效的原因
  - 原因：不同 JVM 的对象不是同一个
  - 问题：用户可以在不同服务器上同时下单

#### 2. 代码修改
- ✅ `VoucherOrderServiceImpl.java` - 添加乐观锁和 synchronized
- ✅ `ShopController.java` - 添加 `/shop/list` 接口
- ✅ `HmDianPingApplicationTests.java` - 添加测试方法

#### 3. 测试验证
- ✅ 单次秒杀测试 - 通过
- ✅ 一人多单测试 - 通过
- ✅ 并发秒杀测试 - 100 个用户同时抢购，全部成功
- ✅ 数据库验证：
  - 库存：100 → 0
  - 订单：100 张
  - 无超卖，无一人多单

#### 4. 项目配置
- ✅ 配置 IDEA 运行配置（一键启动前后端）
- ✅ 修复前端接口问题
- ✅ 添加测试秒杀券（ID=10，库存100）

---

## 📝 核心知识点总结

### 1. 乐观锁 vs 悲观锁

| 对比项 | 乐观锁 | 悲观锁 |
|--------|--------|--------|
| **加锁时机** | 不加锁，操作时判断 | 操作前加锁 |
| **实现方式** | CAS、版本号 | synchronized、Lock |
| **适用场景** | 冲突少（扣库存） | 冲突多（一人一单） |
| **性能** | 高（不阻塞） | 低（排队） |

### 2. 锁的粒度
```java
// ❌ 错误：锁粒度太大
synchronized (this) {
    // 所有用户都排队
}

// ✅ 正确：按用户 ID 加锁
synchronized (userId.toString().intern()) {
    // 只有同一用户的请求才排队
}
```

### 3. 集群环境下的问题
- **问题**：`synchronized` 锁的是 JVM 内的对象
- **原因**：不同服务器的 JVM 不同，对象不同
- **结果**：锁失效，用户可以在多台服务器上同时下单

---

## 🎯 明天的学习计划

### 第 4 章：分布式锁

#### 1. Redis 分布式锁基础
- [ ] 理解分布式锁的原理
- [ ] 学习 Redis `SETNX` 命令
- [ ] 实现简单的分布式锁

#### 2. 分布式锁的三大问题
- [ ] **误删锁问题** - 线程 A 删除了线程 B 的锁
  - 解决方案：存入线程标识（UUID + ThreadId）

- [ ] **原子性问题** - 判断锁和删除锁不是原子操作
  - 解决方案：Lua 脚本

- [ ] **锁续期问题** - 业务执行时间超过锁过期时间
  - 解决方案：看门狗机制

#### 3. 代码实现
- [ ] 创建 `SimpleRedisLock` 类
- [ ] 实现 `tryLock()` 和 `unlock()` 方法
- [ ] 编写 Lua 脚本
- [ ] 替换 `synchronized` 为 Redis 分布式锁
- [ ] 测试集群环境下的一人一单

---

## 📂 代码文件清单

### 已修改的文件
1. `dianping-backend/src/main/java/com/hmdp/service/impl/VoucherOrderServiceImpl.java`
   - 添加乐观锁（防超卖）
   - 添加 synchronized（防一人多单）

2. `dianping-backend/src/main/java/com/hmdp/controller/ShopController.java`
   - 添加 `/shop/list` 接口

3. `dianping-backend/src/test/java/com/hmdp/HmDianPingApplicationTests.java`
   - 添加秒杀测试方法

4. `dianping-backend/src/main/java/com/hmdp/HmDianPingApplication.java`
   - 添加自动打开浏览器功能

### 待创建的文件（明天）
1. `dianping-backend/src/main/java/com/hmdp/utils/SimpleRedisLock.java`
   - 自己实现的 Redis 分布式锁

2. `dianping-backend/src/main/resources/unlock.lua`
   - Lua 脚本（原子性删除锁）

---

## 🤔 待解决的问题

### 1. 前端问题
- ✅ 商户列表加载失败 - 已修复接口返回格式
- ⏳ 需要重启后端验证

### 2. 学习疑问
- ❓ 如何在集群环境下实现分布式锁？
- ❓ Lua 脚本如何保证原子性？
- ❓ 看门狗机制是什么？

---

## 💡 学习心得

### 今天的收获
1. 理解了并发问题的本质：**非原子操作**
2. 学会了用**乐观锁**解决超卖问题
3. 理解了**锁的粒度**的重要性
4. 认识到 `synchronized` 在集群环境下的局限性

### 需要加强的地方
1. 对 JVM 内存模型的理解（为什么不同 JVM 的对象不同）
2. 对分布式系统的理解（集群、负载均衡）
3. 对 Redis 命令的熟悉程度

---

## 📊 学习统计

- **学习时间**：约 3 小时
- **代码行数**：约 100 行
- **测试用例**：3 个
- **理解程度**：70%（理论理解，需要更多实践）

---

## 🔗 相关资源

- 文档：`docs/资料/Redis实战篇.md`
- 数据库：`docs/hmdp.sql`
- 测试秒杀券：ID=10，库存=0（已用完）

---

**下次学习时间：2025年2月14日**
**下次学习内容：第 4 章 - 分布式锁**
